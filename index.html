<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Mapper Studio</title>
    <!-- Подключаем библиотеки -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { 
            background-color: #131314; 
            color: #e3e3e3;
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden;
        }

        /* Анимированный фон за картинкой */
        .animated-bg {
            background: radial-gradient(circle at 50% 50%, #1e1f20 0%, #131314 100%);
            position: relative;
            overflow: hidden;
        }
        .animated-bg::before {
            content: "";
            position: absolute;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg at 50% 50%, transparent, #1a73e810, transparent);
            animation: rotate 20s linear infinite;
        }
        @keyframes rotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Кастомный скроллбар в стиле Chrome/Gemini */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3c4043; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #5f6368; }

        /* Снег */
        #snow-canvas {
            position: fixed;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 9999;
        }

        .glass-panel {
            background: rgba(30, 31, 32, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-screen"></div>

    <script type="text/babel">
        const { useState, useCallback, useRef, useEffect } = React;

        // --- Эффект Снега ---
        const SnowEffect = ({ active }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if (!active) return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let animationId;
                
                const particles = Array.from({ length: 150 }, () => ({
                    x: Math.random() * window.innerWidth,
                    y: Math.random() * window.innerHeight,
                    r: Math.random() * 3 + 1,
                    d: Math.random() * 1,
                    v: Math.random() * 1 + 0.5
                }));

                const draw = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = "white";
                    ctx.beginPath();
                    particles.forEach(p => {
                        ctx.moveTo(p.x, p.y);
                        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                        p.y += p.v;
                        p.x += Math.sin(p.d) * 0.5;
                        if (p.y > canvas.height) p.y = -10;
                    });
                    ctx.fill();
                    animationId = requestAnimationFrame(draw);
                };

                const resize = () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                };

                window.addEventListener('resize', resize);
                resize();
                draw();
                return () => {
                    cancelAnimationFrame(animationId);
                    window.removeEventListener('resize', resize);
                };
            }, [active]);

            return active ? <canvas ref={canvasRef} id="snow-canvas" /> : null;
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={name} style={{width: size, height: size}} className={`inline-block ${className}`}></i>;
        };

        // --- Основной компонент приложения ---
        const App = () => {
            const [points, setPoints] = useState([]);
            const [selectedPointId, setSelectedPointId] = useState(null);
            const [imageState, setImageState] = useState({ src: '', width: 0, height: 0 });
            const [zoom, setZoom] = useState(1);
            const [isSnowing, setIsSnowing] = useState(false);
            const mapRef = useRef(null);

            const handleImageUpload = (event) => {
                const file = event.target.files?.[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            setImageState({ src: e.target.result, width: img.width, height: img.height });
                            setPoints([]);
                            setZoom(1);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleAddPoint = (e) => {
                if (!imageState.src || e.target.closest('.map-pin')) return;
                const rect = e.currentTarget.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                
                const newId = points.length > 0 ? Math.max(...points.map(p => p.id)) + 1 : 1;
                const newPoint = { id: newId, x, y, dbm: '' };
                setPoints([...points, newPoint]);
                setSelectedPointId(newId);
            };

            const handleExport = async () => {
                if (points.length === 0) return alert("Нет данных для экспорта");
                
                // Excel
                const data = points.map(p => ({ "Point №": p.id, "dBm": p.dbm || "0" }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "WiFi Data");
                XLSX.writeFile(wb, "wifi_report.xlsx");

                // PNG
                if (mapRef.current) {
                    const dataUrl = await htmlToImage.toPng(mapRef.current);
                    const link = document.createElement('a');
                    link.download = 'wifi_map.png';
                    link.href = dataUrl;
                    link.click();
                }
            };

            return (
                <div className="flex flex-col h-full bg-[#131314] overflow-hidden">
                    <SnowEffect active={isSnowing} />
                    
                    {/* Header */}
                    <header className="h-14 flex items-center justify-between px-4 border-b border-[#3c4043] bg-[#1e1f20] shrink-0 z-50">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-[#1a73e8] rounded-lg flex items-center justify-center shadow-lg">
                                <Icon name="zap" size={18} className="text-white fill-current" />
                            </div>
                            <span className="font-medium text-[#e3e3e3] text-sm tracking-tight">WiFi Signal Mapper</span>
                        </div>

                        <div className="flex items-center gap-2">
                            <button 
                                onClick={() => setIsSnowing(!isSnowing)}
                                className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium transition-all ${isSnowing ? 'bg-white text-black' : 'hover:bg-[#3c4043] text-[#c4c7c5]'}`}
                            >
                                <Icon name="snowflake" size={14} />
                                <span>Let it snow</span>
                            </button>
                            
                            {imageState.src && (
                                <button onClick={handleExport} className="bg-[#1a73e8] hover:bg-[#1b66c9] text-white px-4 py-1.5 rounded-full text-xs font-medium transition-all shadow-md flex items-center gap-2">
                                    <Icon name="download" size={14} />
                                    Экспорт
                                </button>
                            )}
                        </div>
                    </header>

                    <main className="flex-1 flex overflow-hidden">
                        {/* Sidebar */}
                        <aside className="w-[300px] border-r border-[#3c4043] bg-[#1e1f20] flex flex-col shrink-0">
                            <div className="p-4 border-b border-[#3c4043] flex items-center justify-between">
                                <span className="text-xs font-semibold text-[#c4c7c5] uppercase tracking-wider">Точки ({points.length})</span>
                                {imageState.src && (
                                    <button onClick={() => setPoints([])} className="text-[#c4c7c5] hover:text-white transition-colors">
                                        <Icon name="trash-2" size={16} />
                                    </button>
                                )}
                            </div>
                            
                            <div className="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2">
                                {!imageState.src ? (
                                    <div className="h-full flex flex-col items-center justify-center text-center p-6 space-y-4">
                                        <div className="w-12 h-12 rounded-full bg-[#3c4043] flex items-center justify-center">
                                            <Icon name="upload-cloud" size={24} className="text-[#c4c7c5]" />
                                        </div>
                                        <p className="text-sm text-[#c4c7c5]">Загрузите план этажа,<br/>чтобы начать работу</p>
                                        <label className="bg-[#1a73e8] text-white px-4 py-2 rounded-lg text-xs font-medium cursor-pointer hover:bg-[#1b66c9]">
                                            Выбрать файл
                                            <input type="file" className="hidden" onChange={handleImageUpload} accept="image/*" />
                                        </label>
                                    </div>
                                ) : (
                                    points.map(p => (
                                        <div 
                                            key={p.id}
                                            onClick={() => setSelectedPointId(p.id)}
                                            className={`p-3 rounded-xl transition-all cursor-pointer border ${selectedPointId === p.id ? 'bg-[#28292a] border-[#1a73e8]' : 'bg-[#1e1f20] border-transparent hover:bg-[#28292a]'}`}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className={`w-7 h-7 rounded-md flex items-center justify-center text-xs font-bold ${selectedPointId === p.id ? 'bg-[#1a73e8] text-white' : 'bg-[#3c4043] text-[#c4c7c5]'}`}>
                                                    {p.id}
                                                </div>
                                                <div className="flex-1 relative">
                                                    <input 
                                                        type="number"
                                                        value={p.dbm}
                                                        placeholder="0"
                                                        className="w-full bg-transparent border-none outline-none text-[#e3e3e3] font-mono text-base placeholder:text-[#5f6368]"
                                                        onChange={(e) => setPoints(points.map(pt => pt.id === p.id ? {...pt, dbm: e.target.value} : pt))}
                                                    />
                                                    <span className="absolute right-0 top-1 text-[10px] text-[#5f6368] font-bold">dBm</span>
                                                </div>
                                                <button onClick={(e) => { e.stopPropagation(); setPoints(points.filter(pt => pt.id !== p.id)); }} className="text-[#5f6368] hover:text-red-400">
                                                    <Icon name="x" size={14} />
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </aside>

                        {/* Map Area */}
                        <section className="flex-1 relative animated-bg flex items-center justify-center overflow-auto p-10 custom-scrollbar">
                            {imageState.src ? (
                                <>
                                    {/* Zoom Controls */}
                                    <div className="fixed bottom-6 right-[320px] z-50 flex flex-col gap-2 glass-panel p-2 rounded-2xl">
                                        <button onClick={() => setZoom(z => Math.min(z + 0.2, 3))} className="w-10 h-10 flex items-center justify-center hover:bg-[#3c4043] rounded-xl text-[#c4c7c5]"><Icon name="zoom-in" size={20}/></button>
                                        <button onClick={() => setZoom(1)} className="w-10 h-10 flex items-center justify-center hover:bg-[#3c4043] rounded-xl text-[#c4c7c5] text-[10px] font-bold underline">1:1</button>
                                        <button onClick={() => setZoom(z => Math.max(z - 0.2, 0.5))} className="w-10 h-10 flex items-center justify-center hover:bg-[#3c4043] rounded-xl text-[#c4c7c5]"><Icon name="zoom-out" size={20}/></button>
                                    </div>

                                    <div 
                                        ref={mapRef}
                                        onClick={handleAddPoint}
                                        className="relative shadow-2xl transition-transform duration-200 ease-out origin-center cursor-crosshair"
                                        style={{ transform: `scale(${zoom})`, backgroundColor: 'white' }}
                                    >
                                        <img src={imageState.src} className="block max-w-none h-auto select-none" style={{ maxHeight: '80vh' }} draggable={false} />
                                        {points.map(p => (
                                            <div 
                                                key={p.id}
                                                className={`map-pin absolute -translate-x-1/2 -translate-y-1/2 flex items-center justify-center rounded-full border-2 transition-all shadow-xl ${selectedPointId === p.id ? 'w-9 h-9 bg-[#1a73e8] border-white z-20 scale-110' : 'w-7 h-7 bg-red-500 border-white z-10'}`}
                                                style={{ left: `${p.x}%`, top: `${p.y}%` }}
                                            >
                                                <span className="text-[10px] font-bold text-white">{p.id}</span>
                                                {p.dbm && (
                                                    <div className="absolute top-full mt-1 px-2 py-0.5 bg-[#1e1f20] text-white text-[9px] rounded-md font-bold whitespace-nowrap shadow-md border border-[#3c4043]">
                                                        {p.dbm} dBm
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </>
                            ) : (
                                <div className="text-[#3c4043] flex flex-col items-center">
                                    <Icon name="layers" size={80} className="opacity-20 mb-4" />
                                    <p className="text-xl font-medium">Workspace</p>
                                </div>
                            )}
                        </section>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
