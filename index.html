<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Signal Mapper Pro</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Библиотека для захвата скриншота HTML узла -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    
    <style>
        body { overscroll-behavior-y: none; }
        .map-pin { transition: transform 0.2s; }
        .map-pin:hover { transform: translate(-50%, -50%) scale(1.1); }
        /* Стили для скроллбара в боковой панели */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 h-screen overflow-hidden select-none">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useCallback, useRef, useEffect } = React;

        // --- Компонент иконок Lucide ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} style={{width: size, height: size}} className={`inline-block ${className}`}></i>;
        };

        const MapCanvas = ({ imageState, points, onAddPoint, onSelectPoint, selectedPointId, onUpload, mapRef }) => {
            const containerRef = useRef(null);
            
            const handleClick = (e) => {
                if (!imageState.src || !containerRef.current) return;
                if (e.target.closest('.map-pin')) return;
                
                const rect = containerRef.current.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                onAddPoint(x, y);
            };

            if (!imageState.src) {
                return (
                    <div className="flex items-center justify-center h-full w-full p-8">
                        <div className="max-w-md w-full border-4 border-dashed border-slate-300 rounded-3xl p-12 text-center bg-white/50">
                            <div className="bg-blue-500 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl shadow-blue-200">
                                <Icon name="image" size={40} className="text-white" />
                            </div>
                            <h3 className="text-2xl font-bold text-slate-800 mb-2">План этажа</h3>
                            <p className="text-slate-500 mb-8">Загрузите изображение помещения, чтобы начать расстановку точек замера</p>
                            <label className="inline-flex items-center gap-2 px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl cursor-pointer transition-all transform hover:scale-105 active:scale-95 shadow-lg shadow-blue-200">
                                <Icon name="plus" />
                                <span>Выбрать файл</span>
                                <input type="file" accept="image/*" className="hidden" onChange={onUpload} />
                            </label>
                        </div>
                    </div>
                );
            }

            return (
                <div className="relative w-full h-full bg-slate-200 flex items-center justify-center p-4 overflow-auto custom-scrollbar">
                    {/* Этот контейнер mapRef мы будем "фоткать" */}
                    <div 
                        ref={(el) => { containerRef.current = el; mapRef.current = el; }} 
                        className="relative shadow-2xl bg-white" 
                        onClick={handleClick}
                    >
                        <img 
                            src={imageState.src} 
                            className="block max-w-none h-auto select-none pointer-events-none" 
                            style={{ maxHeight: '85vh' }} 
                            draggable={false} 
                        />
                        {points.map((point) => (
                            <div 
                                key={point.id} 
                                onClick={(e) => { e.stopPropagation(); onSelectPoint(point.id); }}
                                className={`map-pin absolute transform -translate-x-1/2 -translate-y-1/2 flex items-center justify-center rounded-full border-2 shadow-lg cursor-pointer transition-all ${
                                    selectedPointId === point.id 
                                    ? 'w-10 h-10 bg-blue-600 border-white text-white z-30 scale-110 ring-4 ring-blue-500/30' 
                                    : 'w-8 h-8 bg-red-500 border-white text-white z-20 hover:bg-red-600'
                                }`}
                                style={{ left: `${point.x}%`, top: `${point.y}%` }}
                            >
                                <span className="font-bold text-xs">{point.id}</span>
                                {point.dbm && (
                                    <div className="absolute top-full mt-2 px-2 py-1 bg-slate-800 text-white text-[10px] font-bold rounded shadow-md whitespace-nowrap pointer-events-none">
                                        {point.dbm} dBm
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [points, setPoints] = useState([]);
            const [selectedPointId, setSelectedPointId] = useState(null);
            const [imageState, setImageState] = useState({ src: '', width: 0, height: 0 });
            const mapRef = useRef(null); // Реф для экспорта картинки

            const handleImageUpload = (event) => {
                const file = event.target.files?.[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            setImageState({ src: e.target.result, width: img.width, height: img.height });
                            setPoints([]);
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleAddPoint = useCallback((x, y) => {
                const newId = points.length > 0 ? Math.max(...points.map(p => p.id)) + 1 : 1;
                const newPoint = { id: newId, x, y, dbm: '' };
                setPoints([...points, newPoint]);
                setSelectedPointId(newId);
            }, [points]);

            const handleExport = async () => {
                if (points.length === 0) return alert("Добавьте точки для экспорта!");

                // 1. Экспорт в Excel
                const data = points.map(p => ({ "№ Точки": p.id, "Уровень сигнала (dBm)": p.dbm || "н/д" }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "WiFi Measurements");
                XLSX.writeFile(wb, "wifi-survey-data.xlsx");

                // 2. Экспорт в PNG (Карта с точками)
                if (mapRef.current) {
                    try {
                        const dataUrl = await htmlToImage.toPng(mapRef.current, { backgroundColor: '#ffffff' });
                        const link = document.createElement('a');
                        link.download = 'wifi-signal-map.png';
                        link.href = dataUrl;
                        link.click();
                    } catch (err) {
                        console.error('Ошибка при создании изображения:', err);
                    }
                }
            };

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [imageState.src, points]);

            return (
                <div className="flex flex-col h-screen bg-slate-50 font-sans text-slate-900">
                    {/* Шапка */}
                    <header className="bg-white border-b h-16 flex items-center justify-between px-6 shrink-0 z-50 shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-200">
                                <Icon name="wifi" />
                            </div>
                            <div>
                                <h1 className="text-lg font-extrabold leading-none">WiFi Mapper</h1>
                                <p className="text-[10px] text-slate-400 uppercase tracking-widest mt-1">Signal Survey Tool</p>
                            </div>
                        </div>
                        
                        {imageState.src && (
                            <div className="flex gap-2">
                                <button onClick={handleExport} className="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-2.5 rounded-xl flex items-center gap-2 transition-all shadow-md active:scale-95 font-medium">
                                    <Icon name="download" size={18} />
                                    <span>Экспорт (Excel + PNG)</span>
                                </button>
                                <button onClick={() => { if(confirm('Очистить проект?')) {setImageState({src:''}); setPoints([]);} }} className="bg-white border border-slate-200 hover:bg-red-50 hover:text-red-500 text-slate-500 p-2.5 rounded-xl transition-all">
                                    <Icon name="trash-2" size={18} />
                                </button>
                            </div>
                        )}
                    </header>

                    <main className="flex-1 flex overflow-hidden">
                        {/* Основная область карты */}
                        <section className="flex-1 relative bg-slate-100 overflow-hidden">
                            <MapCanvas 
                                imageState={imageState} 
                                points={points} 
                                onAddPoint={handleAddPoint} 
                                onSelectPoint={setSelectedPointId} 
                                selectedPointId={selectedPointId} 
                                onUpload={handleImageUpload}
                                mapRef={mapRef}
                            />
                        </section>

                        {/* Боковая панель */}
                        {imageState.src && (
                            <aside className="w-80 bg-white border-l flex flex-col shadow-2xl z-40">
                                <div className="p-4 border-b bg-slate-50/50">
                                    <div className="flex items-center justify-between">
                                        <h3 className="font-bold text-slate-700">Список измерений</h3>
                                        <span className="bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full text-xs font-bold">{points.length}</span>
                                    </div>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                                    {points.length === 0 ? (
                                        <div className="text-center py-10 text-slate-400">
                                            <Icon name="mouse-pointer-2" size={32} className="mx-auto mb-2 opacity-20" />
                                            <p className="text-sm">Нажмите на карту,<br/>чтобы поставить точку</p>
                                        </div>
                                    ) : (
                                        points.slice().reverse().map(p => (
                                            <div 
                                                key={p.id} 
                                                onClick={() => setSelectedPointId(p.id)} 
                                                className={`p-3 rounded-xl border-2 transition-all cursor-pointer ${
                                                    selectedPointId === p.id 
                                                    ? 'border-blue-500 bg-blue-50 shadow-sm' 
                                                    : 'border-slate-100 bg-white hover:border-slate-200'
                                                }`}
                                            >
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm shrink-0 ${
                                                        selectedPointId === p.id ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-500'
                                                    }`}>
                                                        {p.id}
                                                    </div>
                                                    <div className="flex-1 relative">
                                                        <input 
                                                            type="number" 
                                                            value={p.dbm} 
                                                            placeholder="-65" 
                                                            className="w-full bg-transparent border-b-2 border-slate-200 focus:border-blue-400 outline-none font-mono font-bold text-lg pr-8" 
                                                            onChange={(e) => setPoints(points.map(pt => pt.id === p.id ? {...pt, dbm: e.target.value} : pt))} 
                                                        />
                                                        <span className="absolute right-0 bottom-1 text-[10px] text-slate-400 font-bold">dBm</span>
                                                    </div>
                                                    <button 
                                                        onClick={(e) => { e.stopPropagation(); setPoints(points.filter(pt => pt.id !== p.id)); }} 
                                                        className="text-slate-300 hover:text-red-500 transition-colors p-1"
                                                    >
                                                        <Icon name="x" size={18} />
                                                    </button>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>

                                <div className="p-4 border-t bg-slate-50 text-[11px] text-slate-400 text-center leading-tight">
                                    Кликните по плану, чтобы добавить маркер.<br/>Данные сохраняются только в рамках сессии.
                                </div>
                            </aside>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
