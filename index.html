<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi Mapper Studio</title>
    <!-- Библиотеки -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono&display=swap');
        
        :root {
            --bg-color: #131314;
            --panel-color: #1e1f20;
            --accent-color: #1a73e8;
            --border-color: #3c4043;
        }

        body { 
            background-color: var(--bg-color); 
            color: #e3e3e3;
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden;
        }

        /* Новый технологичный фон: Сетка + Радарный засвет */
        .blueprint-bg {
            background-color: var(--bg-color);
            background-image: 
                linear-gradient(var(--border-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--border-color) 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: center center;
            position: relative;
        }
        
        .blueprint-bg::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 50%, rgba(26, 115, 232, 0.1), transparent 70%);
            pointer-events: none;
            animation: pulse 8s infinite alternate;
        }

        @keyframes pulse {
            from { opacity: 0.4; transform: scale(1); }
            to { opacity: 0.8; transform: scale(1.2); }
        }

        /* Снег */
        #snow-canvas {
            position: fixed;
            top: 0; left: 0;
            pointer-events: none;
            z-index: 100;
        }

        /* Кастомный ввод */
        .dbm-input {
            background: transparent;
            border: none;
            outline: none;
            color: #e3e3e3;
            font-family: 'JetBrains Mono', monospace;
            width: 100%;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #444746; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useRef, useEffect, useMemo } = React;

        // Безопасный компонент иконки
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    window.lucide.createIcons({
                        attrs: { class: className, strokeWidth: 2, width: size, height: size },
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name, className, size]);
            return <i ref={iconRef} data-lucide={name}></i>;
        };

        const SnowEffect = ({ active }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if (!active) return;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let animationId;
                const particles = Array.from({ length: 100 }, () => ({
                    x: Math.random() * window.innerWidth,
                    y: Math.random() * window.innerHeight,
                    r: Math.random() * 2 + 1,
                    v: Math.random() * 1 + 0.5
                }));
                const draw = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
                    particles.forEach(p => {
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                        ctx.fill();
                        p.y += p.v;
                        if (p.y > canvas.height) p.y = -5;
                    });
                    animationId = requestAnimationFrame(draw);
                };
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                draw();
                return () => cancelAnimationFrame(animationId);
            }, [active]);
            return active ? <canvas ref={canvasRef} id="snow-canvas" /> : null;
        };

        const App = () => {
            const [points, setPoints] = useState([]);
            const [selectedPointId, setSelectedPointId] = useState(null);
            const [image, setImage] = useState(null);
            const [zoom, setZoom] = useState(1);
            const [isSnowing, setIsSnowing] = useState(false);
            const mapRef = useRef(null);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    setImage(event.target.result);
                    setPoints([]);
                    setZoom(1);
                };
                reader.readAsDataURL(file);
            };

            const addPoint = (e) => {
                if (e.target.closest('.map-pin')) return;
                const rect = e.currentTarget.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                const newId = points.length > 0 ? Math.max(...points.map(p => p.id)) + 1 : 1;
                const newPoint = { id: newId, x, y, dbm: '' };
                setPoints([...points, newPoint]);
                setSelectedPointId(newId);
            };

            const exportData = async () => {
                if (points.length === 0) return alert("Добавьте точки!");
                
                // 1. Excel
                const ws = XLSX.utils.json_to_sheet(points.map(p => ({ "ID": p.id, "Сигнал (dBm)": p.dbm || "0" })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "WiFi");
                XLSX.writeFile(wb, "wifi_report.xlsx");

                // 2. PNG
                if (mapRef.current) {
                    const dataUrl = await htmlToImage.toPng(mapRef.current);
                    const link = document.createElement('a');
                    link.download = 'wifi_map.png';
                    link.href = dataUrl;
                    link.click();
                }
            };

            return (
                <div className="flex flex-col h-screen w-screen overflow-hidden">
                    <SnowEffect active={isSnowing} />
                    
                    {/* Top Bar */}
                    <header className="h-14 bg-[#1e1f20] border-b border-[#3c4043] flex items-center justify-between px-6 z-50">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-[#1a73e8] rounded-lg flex items-center justify-center shadow-lg shadow-blue-900/20">
                                <Icon name="wifi" size={18} className="text-white" />
                            </div>
                            <h1 className="text-sm font-semibold tracking-wide text-[#e3e3e3]">WIFI MAPPER STUDIO</h1>
                        </div>

                        <div className="flex items-center gap-3">
                            <button 
                                onClick={() => setIsSnowing(!isSnowing)}
                                className={`flex items-center gap-2 px-4 py-1.5 rounded-full text-xs transition-all ${isSnowing ? 'bg-white text-black font-bold' : 'bg-[#3c4043] text-[#c4c7c5] hover:bg-[#4f5255]'}`}
                            >
                                <Icon name="snowflake" size={14} />
                                <span>Let it snow</span>
                            </button>
                            {image && (
                                <button onClick={exportData} className="bg-[#1a73e8] hover:bg-[#1b66c9] text-white px-5 py-1.5 rounded-full text-xs font-medium shadow-md transition-all">
                                    Экспорт
                                </button>
                            )}
                        </div>
                    </header>

                    <main className="flex-1 flex overflow-hidden">
                        {/* Sidebar */}
                        <aside className="w-72 bg-[#1e1f20] border-r border-[#3c4043] flex flex-col shrink-0 z-40">
                            <div className="p-4 border-b border-[#3c4043] flex items-center justify-between">
                                <span className="text-[10px] font-bold text-[#9aa0a6] uppercase tracking-widest">Измерения ({points.length})</span>
                                {image && <button onClick={() => setPoints([])} className="text-[#9aa0a6] hover:text-red-400"><Icon name="trash-2" size={14}/></button>}
                            </div>

                            <div className="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar">
                                {!image ? (
                                    <div className="h-full flex flex-col items-center justify-center text-center opacity-40">
                                        <Icon name="image-plus" size={40} className="mb-4" />
                                        <p className="text-xs">Загрузите план помещения</p>
                                    </div>
                                ) : (
                                    points.map(p => (
                                        <div key={p.id} onClick={() => setSelectedPointId(p.id)} 
                                             className={`p-3 rounded-xl border transition-all cursor-pointer ${selectedPointId === p.id ? 'bg-[#2d2f31] border-[#1a73e8]' : 'bg-[#1e1f20] border-[#3c4043] hover:border-[#5f6368]'}`}>
                                            <div className="flex items-center gap-3">
                                                <div className={`w-6 h-6 rounded flex items-center justify-center text-[10px] font-bold ${selectedPointId === p.id ? 'bg-[#1a73e8] text-white' : 'bg-[#3c4043] text-[#9aa0a6]'}`}>{p.id}</div>
                                                <div className="flex-1 relative">
                                                    <input 
                                                        type="number" value={p.dbm} placeholder="0" className="dbm-input text-sm"
                                                        onChange={(e) => setPoints(points.map(pt => pt.id === p.id ? {...pt, dbm: e.target.value} : pt))}
                                                    />
                                                    <span className="absolute right-0 top-0 text-[10px] text-[#5f6368] font-bold">dBm</span>
                                                </div>
                                                <button onClick={(e) => { e.stopPropagation(); setPoints(points.filter(pt => pt.id !== p.id)); }} className="text-[#5f6368] hover:text-red-400"><Icon name="x" size={14}/></button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                            
                            {!image && (
                                <div className="p-4 bg-[#131314]">
                                    <label className="block w-full bg-[#1a73e8] hover:bg-[#1b66c9] text-white text-center py-3 rounded-xl text-xs font-bold cursor-pointer transition-all">
                                        ВЫБРАТЬ ФАЙЛ
                                        <input type="file" className="hidden" onChange={handleFileUpload} accept="image/*" />
                                    </label>
                                </div>
                            )}
                        </aside>

                        {/* Editor Area */}
                        <section className="flex-1 relative blueprint-bg flex items-center justify-center overflow-auto custom-scrollbar p-12">
                            {image ? (
                                <>
                                    {/* Zoom Control */}
                                    <div className="fixed bottom-8 left-80 z-50 flex gap-1 bg-[#1e1f20]/80 backdrop-blur-md p-1.5 rounded-2xl border border-[#3c4043] shadow-2xl">
                                        <button onClick={() => setZoom(z => Math.max(z - 0.2, 0.4))} className="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-[#3c4043] text-[#c4c7c5]"><Icon name="minus" size={18}/></button>
                                        <button onClick={() => setZoom(1)} className="px-3 text-[10px] font-bold text-[#c4c7c5] hover:text-white uppercase tracking-tighter">100%</button>
                                        <button onClick={() => setZoom(z => Math.min(z + 0.2, 3))} className="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-[#3c4043] text-[#c4c7c5]"><Icon name="plus" size={18}/></button>
                                    </div>

                                    <div 
                                        ref={mapRef} onClick={addPoint}
                                        className="relative shadow-[0_0_50px_rgba(0,0,0,0.5)] transition-transform duration-300 ease-out origin-center"
                                        style={{ transform: `scale(${zoom})`, backgroundColor: 'white' }}
                                    >
                                        <img src={image} className="block max-w-none h-auto select-none pointer-events-none" style={{maxHeight: '80vh'}} />
                                        {points.map(p => (
                                            <div key={p.id} 
                                                 className={`map-pin absolute -translate-x-1/2 -translate-y-1/2 flex flex-col items-center pointer-events-auto ${selectedPointId === p.id ? 'z-30' : 'z-20'}`}
                                                 style={{ left: `${p.x}%`, top: `${p.y}%` }}>
                                                <div className={`w-8 h-8 rounded-full border-2 border-white shadow-lg flex items-center justify-center text-[10px] font-bold text-white transition-transform ${selectedPointId === p.id ? 'bg-[#1a73e8] scale-125' : 'bg-red-500 hover:scale-110'}`}>
                                                    {p.id}
                                                </div>
                                                {p.dbm && (
                                                    <div className="mt-1 bg-[#1e1f20] text-white text-[9px] px-2 py-0.5 rounded border border-[#3c4043] font-mono shadow-xl">
                                                        {p.dbm} dBm
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </>
                            ) : (
                                <div className="flex flex-col items-center text-[#3c4043]">
                                    <Icon name="layout" size={100} className="opacity-10 mb-6" />
                                    <h2 className="text-2xl font-light tracking-tighter uppercase opacity-20">No Project Loaded</h2>
                                </div>
                            )}
                        </section>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
